@{
    ViewBag.Title = "TicTacToe";
}

<div class="row">
    <div class="col-md-12">
        <table class="tictactoe">
            <tr id="row-0">
                <td id="field-0-0"></td>
                <td id="field-1-0"></td>
                <td id="field-2-0"></td>
            </tr>
            <tr id="row-1">
                <td id="field-0-1"></td>
                <td id="field-1-1"></td>
                <td id="field-2-1"></td>
            </tr>
            <tr id="row-2">
                <td id="field-0-2"></td>
                <td id="field-1-2"></td>
                <td id="field-2-2"></td>
            </tr>
        </table>
        <h2 id="game"></h2>
        <h2 id="msg"></h2>
    </div>
</div>

@section scripts {
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.4.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script>
        $(function () {
            var gameId = @ViewBag.Id;             // Id of the game
            var myChar = ' ';                     // My char, 'X' or 'O'
            var canPlay = false;                  // true => my turn
            var hub = $.connection.ticTacToeHub;  // reference to the hub

            // Called by the hub when joining to the game.
            // - id      Id of the game
            // - ch      My char, 'X' or 'O'
            // - nextCh  Next to play    
            hub.client.join = function (id, ch, nextCh) {
                if (gameId == id) {
                    $("#game").html("id="+gameId+" "+ch);
                    myChar = ch;
                    hub.client.prompt(id, nextCh);
                }
            };

            // Called by the join-method above or by the hub when the
            // client is prompted to wait or to play.
            // - id  Id of the game
            // - ch  Next to play
            hub.client.prompt = function (id, ch) {
                if (gameId == id) {
                    canPlay = (ch == myChar);
                    if (canPlay) 
                        $("#msg").html("Your turn");
                    else if (ch == ' ')
                        $("#msg").html("Wait for opponent to join");
                    else
                        $("#msg").html("Wait for opponent to play");
                }
            };

            // Called by the hub to set the status of a field.
            // - id  Id of the game
            // - x   X-Position of the field to set
            // - y   Y-Position of the field to set
            // - ch  Character to set
            hub.client.setField = function (id, x, y, ch) {
                if (gameId == id) {
                    $("#field-"+x+"-"+y).html(ch).addClass("set");
                }
            };

            // Called by the hub when the game has ended.
            // - id  Id of the game
            // - ch  Winner-Character (' ' for a tie)
            hub.client.ended = function (id, ch) {
                if (gameId == id) {
                    canPlay = false;
                    if (ch == ' ')
                        $("#msg").html("Gamed ended with a tie");
                    else if (ch == myChar)
                        $("#msg").html("You win !!!");
                    else
                        $("#msg").html("You loose!");
                }
            };

            $.connection.hub.start().done(function () {
                hub.server.join(gameId);

                $("td").click(function(){
                    if (canPlay) {
                        if (!$(this.id).hasClass("set")) {
                            var x = this.id.substr(6, 1);
                            var y = this.id.substr(8, 1);
                            hub.server.play(gameId, x, y, myChar);
                        }
                    }
                });
            });
        });
    </script>
}